<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0A0F1E">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="DeliverPro">
<title>DeliverPro</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<style>
:root{
  --bg:#0A0F1E; --s:#111827; --s2:#1a2235; --s3:#243049;
  --blue:#3B82F6; --indigo:#6366F1; --green:#10B981; --orange:#F59E0B;
  --red:#EF4444; --purple:#8B5CF6; --yellow:#FBBF24; --teal:#14B8A6;
  --pink:#EC4899;
  --tx:#F1F5F9; --tx2:#94A3B8; --tx3:#475569;
  --br:rgba(255,255,255,0.08);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;padding-bottom:80px}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.hdr{background:linear-gradient(135deg,#0d1526,#1a2540);padding:12px 16px 10px;position:sticky;top:0;z-index:100;border-bottom:1px solid var(--br);box-shadow:0 2px 20px rgba(0,0,0,0.5)}
.hdr-row1{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.logo{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;background:linear-gradient(135deg,#3B82F6,#8B5CF6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdr-btns{display:flex;gap:6px}
.hbtn{padding:7px 12px;border-radius:8px;border:none;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer}
.hbtn-p{background:linear-gradient(135deg,#3B82F6,#6366F1);color:#fff}
.hbtn-g{background:var(--s2);color:var(--tx);border:1px solid var(--br)}

/* STAT BOXES */
.stats-row{display:flex;flex-direction:row;flex-wrap:nowrap;gap:8px;overflow-x:auto;padding-bottom:2px;-webkit-overflow-scrolling:touch}
.stat{background:var(--s2);border:1px solid var(--br);border-radius:10px;padding:7px 12px;flex-shrink:0;text-align:center;min-width:58px}
.stat-v{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;display:block}
.stat-l{font-size:10px;color:var(--tx2);margin-top:1px;display:block;white-space:nowrap}

/* GOOGLE BAR */
.gbar{display:flex;align-items:center;gap:10px;padding:10px 14px;margin:10px 16px 0;border-radius:12px;cursor:pointer;border:1px solid rgba(59,130,246,0.25);background:rgba(59,130,246,0.08)}
.gbar.on{border-color:rgba(16,185,129,0.3);background:rgba(16,185,129,0.08)}
.gav{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,#3B82F6,#8B5CF6);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;overflow:hidden}
.gav img{width:100%;height:100%;object-fit:cover}
.ginfo{flex:1;min-width:0}
.gnm{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gsb{font-size:11px;color:var(--tx2)}
.gact{font-size:12px;font-weight:700;color:var(--blue);white-space:nowrap}
.gact.on{color:var(--green)}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.nav{position:fixed;bottom:0;left:0;right:0;background:rgba(13,21,38,0.98);backdrop-filter:blur(20px);border-top:1px solid var(--br);display:flex;z-index:200}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;padding:9px 4px 7px;background:none;border:none;color:var(--tx3);font-family:'DM Sans',sans-serif;font-size:10px;cursor:pointer;gap:3px;transition:color 0.2s}
.nb.active{color:var(--blue)}
.nb svg{width:21px;height:21px}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.scr{display:none;padding:14px 16px;animation:fi 0.25s ease}
.scr.active{display:block}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ SECTION TITLE ‚îÄ‚îÄ */
.stitle{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--tx2);margin:16px 0 10px;display:flex;align-items:center;gap:8px}
.stitle::after{content:'';flex:1;height:1px;background:var(--br)}

/* ‚îÄ‚îÄ PARCEL CARD ‚îÄ‚îÄ */
.pcard{background:var(--s);border:1px solid var(--br);border-radius:14px;margin-bottom:10px;overflow:hidden;transition:all 0.15s}
.pcard.today{border-color:rgba(16,185,129,0.5);box-shadow:0 0 16px rgba(16,185,129,0.12)}
.pcard.urgent{border-left:3px solid var(--red)}
.pcard.timed{border-left:3px solid var(--yellow)}
.pcard.done{opacity:0.4}
.pcard.active-del{border-color:var(--orange);box-shadow:0 0 20px rgba(245,158,11,0.2)}

.pcard-top{display:flex;align-items:flex-start;gap:10px;padding:12px 14px 8px}
.pthumb{width:46px;height:46px;border-radius:11px;overflow:hidden;background:var(--s2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:20px;position:relative;border:1px solid var(--br)}
.pthumb img{width:100%;height:100%;object-fit:cover}
.pnum{position:absolute;top:-3px;left:-3px;width:18px;height:18px;border-radius:5px;background:var(--blue);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#fff}
.pnum.sel{background:var(--green)}
.pnum.done{background:var(--tx3)}

/* ‚òÖ NAAM BOLD COLOURFUL ‚òÖ */
.pname{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;background:linear-gradient(135deg,#60A5FA,#A78BFA);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1.2}
.pname.today-name{background:linear-gradient(135deg,#34D399,#60A5FA);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.pname.urgent-name{background:linear-gradient(135deg,#F87171,#FB923C);-webkit-background-clip:text;-webkit-text-fill-color:transparent}

.psub{font-size:12px;color:var(--tx2);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.paddr{font-size:12px;color:var(--tx3);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* SELECT CHECKBOX */
.pcheck{width:26px;height:26px;border-radius:8px;border:2px solid var(--tx3);background:transparent;flex-shrink:0;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.15s;margin-left:auto}
.pcheck.on{background:var(--green);border-color:var(--green)}

/* TIME NOTE */
.tnotebox{margin:0 14px 8px;padding:7px 12px;border-radius:9px;display:flex;align-items:center;gap:8px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3)}
.tnotebox.urg{background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3);animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
.tnotebox span{font-size:12px;font-weight:700;color:var(--yellow)}
.tnotebox.urg span{color:var(--red)}

/* PHOTO ROW */
.photo-row{display:flex;gap:6px;padding:0 14px 8px;overflow-x:auto}
.photo-mini{width:48px;height:48px;border-radius:9px;overflow:hidden;flex-shrink:0;cursor:pointer;border:1px solid var(--br)}
.photo-mini img{width:100%;height:100%;object-fit:cover}

/* ACTION CHIPS */
.chips{display:flex;gap:6px;padding:0 14px 12px;flex-wrap:wrap}
.chip{display:flex;align-items:center;gap:4px;padding:6px 11px;border-radius:8px;border:none;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:transform 0.1s}
.chip:active{transform:scale(0.93)}
.c-nav{background:rgba(59,130,246,0.15);color:#60A5FA}
.c-call{background:rgba(16,185,129,0.15);color:#34D399}
.c-photo{background:rgba(139,92,246,0.15);color:#A78BFA}
.c-edit{background:rgba(245,158,11,0.15);color:#FCD34D}
.c-done{background:rgba(16,185,129,0.15);color:#34D399}
.c-del{background:rgba(239,68,68,0.15);color:#F87171}

/* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
#map{height:240px;border-radius:12px;overflow:hidden;border:1px solid var(--br)}
.leaflet-container{background:#0d1526 !important}

/* ROUTE PROGRESS */
.rpbar{height:5px;background:var(--s2);border-radius:3px;margin:8px 0;overflow:hidden}
.rpfill{height:100%;background:linear-gradient(90deg,#10B981,#34D399);border-radius:3px;transition:width 0.6s ease}

/* TODAY ROUTE BAR */
.today-bar{background:linear-gradient(135deg,rgba(16,185,129,0.12),rgba(5,150,105,0.08));border:1px solid rgba(16,185,129,0.3);border-radius:13px;padding:12px 14px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.today-bar-info{flex:1}
.today-bar-title{font-weight:700;font-size:14px;color:var(--green)}
.today-bar-sub{font-size:12px;color:var(--tx2);margin-top:2px}

/* CURRENT DELIVERY CARD */
.cur-card{background:var(--s);border:2px solid var(--orange);border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 0 24px rgba(245,158,11,0.15)}
.cur-photo{width:52px;height:52px;border-radius:12px;overflow:hidden;background:var(--s2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:24px}
.cur-photo img{width:100%;height:100%;object-fit:cover}

/* FLOATING PARCEL */
.fp{position:fixed;bottom:84px;left:12px;right:12px;background:linear-gradient(135deg,#141f35,#1a2a45);border:2px solid var(--orange);border-radius:18px;padding:13px 14px;z-index:180;display:none;box-shadow:0 8px 40px rgba(245,158,11,0.3)}
.fp.show{display:block;animation:fup 0.3s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes fup{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.fp-x{position:absolute;top:10px;right:10px;background:var(--s2);border:none;color:var(--tx2);border-radius:7px;width:26px;height:26px;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center}
.fp-ph{width:44px;height:44px;border-radius:10px;overflow:hidden;background:var(--s2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:20px;border:1px solid var(--br)}
.fp-ph img{width:100%;height:100%;object-fit:cover}
.fp-nm{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;background:linear-gradient(135deg,#60A5FA,#A78BFA);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.fp-btns{display:flex;gap:8px;margin-top:8px}
.fp-nav{flex:2;padding:10px;background:linear-gradient(135deg,#3B82F6,#6366F1);border:none;border-radius:10px;color:#fff;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px}
.fp-call{flex:1;padding:10px;background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);border-radius:10px;color:var(--green);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* PROXIMITY */
.prox{position:fixed;top:0;left:0;right:0;z-index:300;padding:12px 16px;display:none;align-items:center;gap:12px;border-radius:0 0 16px 16px}
.prox.near{display:flex;background:linear-gradient(135deg,#065F46,#047857);border-bottom:2px solid var(--green)}
.prox.vnear{display:flex;background:linear-gradient(135deg,#9A3412,#C2410C);border-bottom:2px solid var(--orange)}
.prox-x{background:rgba(255,255,255,0.15);border:none;color:#fff;border-radius:7px;padding:5px 9px;cursor:pointer;font-size:12px}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.fg{margin-bottom:13px}
.fl{font-size:11px;color:var(--tx2);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;display:block;font-weight:600}
.fi{width:100%;padding:12px 13px;background:var(--s2);border:1px solid var(--br);border-radius:10px;color:var(--tx);font-family:'DM Sans',sans-serif;font-size:15px;outline:none;transition:border-color 0.2s}
.fi:focus{border-color:var(--blue)}
.fi::placeholder{color:var(--tx3)}
textarea.fi{resize:none;height:60px}

.tsec{background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.18);border-radius:11px;padding:13px;margin-bottom:13px}
.tpres{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:9px}
.tp{padding:6px 11px;border-radius:7px;border:1px solid rgba(251,191,36,0.2);background:rgba(251,191,36,0.07);color:var(--yellow);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer}
.tp.sel{background:rgba(251,191,36,0.22);border-color:rgba(251,191,36,0.5)}

/* BUTTONS */
.btn{display:flex;align-items:center;justify-content:center;gap:7px;padding:12px 18px;border-radius:11px;border:none;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;cursor:pointer;width:100%;transition:all 0.15s}
.btn:active{transform:scale(0.97)}
.btn-p{background:linear-gradient(135deg,#3B82F6,#6366F1);color:#fff}
.btn-g{background:linear-gradient(135deg,#10B981,#059669);color:#fff}
.btn-r{background:linear-gradient(135deg,#EF4444,#DC2626);color:#fff}
.btn-gh{background:var(--s2);color:var(--tx);border:1px solid var(--br)}
.btn-sm{padding:8px 13px;font-size:13px;border-radius:8px;width:auto}
.btn-wa{background:linear-gradient(135deg,#25D366,#128C7E);color:#fff}

/* PHOTO GRID */
.pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
.pth2{aspect-ratio:1;border-radius:10px;overflow:hidden;background:var(--s2);border:1px solid var(--br);position:relative;cursor:pointer}
.pth2 img{width:100%;height:100%;object-fit:cover}
.pdel{position:absolute;top:3px;right:3px;background:rgba(239,68,68,0.85);color:#fff;border:none;border-radius:5px;padding:2px 6px;font-size:11px;cursor:pointer}
.padd{aspect-ratio:1;border-radius:10px;background:var(--s2);border:2px dashed rgba(59,130,246,0.3);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:4px;color:var(--blue);font-size:11px;font-weight:600}

/* SEARCH */
.sbar{display:flex;align-items:center;gap:9px;background:var(--s2);border:1px solid var(--br);border-radius:11px;padding:9px 13px;margin-bottom:11px}
.sbar input{background:none;border:none;color:var(--tx);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;flex:1}
.sbar input::placeholder{color:var(--tx3)}

/* FILTER TABS */
.ftabs{display:flex;gap:7px;overflow-x:auto;margin-bottom:11px;padding-bottom:2px}
.ftab{padding:7px 13px;border-radius:8px;border:1px solid var(--br);background:var(--s2);color:var(--tx2);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;flex-shrink:0}
.ftab.on{background:linear-gradient(135deg,#3B82F6,#6366F1);color:#fff;border-color:transparent}

/* SCAN */
.scanbox{position:relative;background:#000;border-radius:14px;overflow:hidden;aspect-ratio:1;max-width:300px;margin:0 auto}
.scanbox video{width:100%;height:100%;object-fit:cover}
.scanov{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
.scanfr{width:60%;aspect-ratio:1;border:3px solid var(--blue);border-radius:14px;box-shadow:0 0 0 9999px rgba(0,0,0,0.55);position:relative}
.scanln{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--blue),transparent);animation:sl 2s linear infinite}
@keyframes sl{0%{top:0}100%{top:100%}}
.scan-tabs{display:flex;gap:7px;margin-bottom:13px}
.stab{flex:1;padding:9px;border-radius:9px;border:1px solid var(--br);background:var(--s2);color:var(--tx2);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;text-align:center}
.stab.on{background:linear-gradient(135deg,#3B82F6,#6366F1);color:#fff;border-color:transparent}

/* OCR */
.ocr-box{background:var(--s2);border-radius:11px;padding:13px;margin-top:11px;display:none}
.ocr-box.show{display:block}
.obar{height:4px;background:var(--s3);border-radius:2px;margin:7px 0;overflow:hidden}
.ofill{height:100%;background:linear-gradient(90deg,var(--blue),var(--purple));border-radius:2px;transition:width 0.3s;width:0%}

/* MODAL */
.mov{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);z-index:500;align-items:flex-end}
.mov.active{display:flex}
.mod{background:var(--s);border-radius:22px 22px 0 0;padding:18px 16px;width:100%;max-height:93vh;overflow-y:auto;animation:su 0.3s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhnd{width:36px;height:4px;background:var(--s3);border-radius:2px;margin:0 auto 14px}
.mtit{font-family:'Syne',sans-serif;font-size:19px;font-weight:700;margin-bottom:16px}

/* LOCATION MODAL */
.lmod{position:fixed;inset:0;background:var(--bg);z-index:600;display:none;flex-direction:column}
.lmod.active{display:flex}
.lhdr{padding:13px 16px;background:var(--s);border-bottom:1px solid var(--br);display:flex;align-items:center;gap:10px;flex-shrink:0}
.lmap{flex:1;position:relative}
.lbot{background:var(--s);padding:13px 16px;border-top:1px solid var(--br);flex-shrink:0}
#lpmap{height:100%}

/* GPS */
.gbox{display:none;border-radius:9px;padding:9px 13px;margin-bottom:9px;align-items:center;gap:10px}
.gbox.show{display:flex}
.gok{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3)}
.gwarn{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3)}
.gbad{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3)}
.gdot{width:10px;height:10px;border-radius:50%;flex-shrink:0;animation:gp 1.5s infinite}
.gok .gdot{background:var(--green)}
.gwarn .gdot{background:var(--orange)}
.gbad .gdot{background:var(--red);animation:none}
@keyframes gp{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(1.4)}}

/* PHOTO VIEWER */
.pview{position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:800;display:none;align-items:center;justify-content:center;flex-direction:column}
.pview.show{display:flex}
.pview img{max-width:95vw;max-height:82vh;border-radius:12px;object-fit:contain}
.pvx{position:absolute;top:18px;right:18px;background:rgba(255,255,255,0.1);border:none;color:#fff;border-radius:9px;padding:9px 14px;cursor:pointer;font-size:15px}

/* TOGGLE */
.tog{width:46px;height:25px;background:var(--s3);border-radius:13px;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0;border:none}
.tog.on{background:var(--blue)}
.tog::after{content:'';position:absolute;width:19px;height:19px;border-radius:50%;background:#fff;top:3px;left:3px;transition:transform 0.2s}
.tog.on::after{transform:translateX(21px)}

/* SELECT MODAL LIST ITEM */
.sel-item{display:flex;align-items:center;gap:11px;padding:11px 4px;border-bottom:1px solid var(--br);cursor:pointer}
.selbox{width:24px;height:24px;border-radius:7px;border:2px solid var(--tx3);background:transparent;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.selbox.on{background:var(--green);border-color:var(--green)}

/* TOAST */
.toast{position:fixed;bottom:88px;left:50%;transform:translateX(-50%);background:#1e2d4a;color:var(--tx);padding:11px 18px;border-radius:11px;font-size:14px;font-weight:500;box-shadow:0 8px 30px rgba(0,0,0,0.6);border:1px solid var(--br);z-index:1000;opacity:0;transition:opacity 0.25s;white-space:nowrap;max-width:90vw}
.toast.show{opacity:1}
.toast.ok{border-color:rgba(16,185,129,0.5)}
.toast.err{border-color:rgba(239,68,68,0.5)}

/* BACKUP ITEM */
.biobtn{display:flex;align-items:center;gap:11px;padding:13px 14px;border-radius:11px;background:var(--s2);border:1px solid var(--br);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;cursor:pointer;margin-bottom:9px;width:100%}
.bioic{width:38px;height:38px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}

/* EMPTY */
.empty{text-align:center;padding:40px 20px;color:var(--tx3)}
.empty div:first-child{font-size:48px;margin-bottom:8px}
</style>
</head>
<body>

<!-- HEADER -->
<div class="hdr">
  <div class="hdr-row1">
    <div class="logo">‚ö° DeliverPro</div>
    <div class="hdr-btns">
      <button class="hbtn hbtn-g" onclick="goScr('scan',document.querySelectorAll('.nb')[2]);startScanner()">üì∑ Scan</button>
      <button class="hbtn hbtn-p" onclick="openAdd()">+ Add</button>
    </div>
  </div>
  <div class="stats-row">
    <div class="stat"><div class="stat-v" id="s0">0</div><div class="stat-l">Total</div></div>
    <div class="stat"><div class="stat-v" style="color:var(--orange)" id="s1">0</div><div class="stat-l">Pending</div></div>
    <div class="stat"><div class="stat-v" style="color:var(--green)" id="s2">0</div><div class="stat-l">Done</div></div>
    <div class="stat"><div class="stat-v" style="color:var(--green)" id="s3">0</div><div class="stat-l">Today ‚úÖ</div></div>
    <div class="stat"><div class="stat-v" style="color:var(--yellow)" id="s4">0</div><div class="stat-l">‚è∞ Timed</div></div>
    <div class="stat"><div class="stat-v" style="color:var(--teal)" id="s5">0</div><div class="stat-l">üì∏ Photos</div></div>
  </div>
</div>

<!-- GOOGLE BAR -->
<div class="gbar" id="gbar" onclick="gLogin()">
  <div class="gav" id="gav">G</div>
  <div class="ginfo">
    <div class="gnm" id="gnm">Google se Login karo</div>
    <div class="gsb" id="gsb">Data + Photos Drive mein auto-save honge</div>
  </div>
  <div class="gact" id="gact">Login ‚Üí</div>
</div>

<!-- PROXIMITY ALERT -->
<div class="prox" id="prox">
  <div style="font-size:26px" id="prox-ic">üìç</div>
  <div style="flex:1"><div style="font-weight:700;font-size:14px" id="prox-t"></div><div style="font-size:12px;opacity:0.8" id="prox-s"></div></div>
  <button class="prox-x" onclick="document.getElementById('prox').className='prox'">‚úï</button>
</div>

<!-- FLOATING PARCEL -->
<div class="fp" id="fp">
  <button class="fp-x" onclick="clearFP()">‚úï</button>
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
    <div class="fp-ph" id="fp-ph">üì¶</div>
    <div style="flex:1;min-width:0">
      <div class="fp-nm" id="fp-nm">‚Äî</div>
      <div style="font-size:12px;color:var(--tx2)" id="fp-ph2"></div>
      <div style="font-size:11px;color:var(--tx3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" id="fp-ad"></div>
    </div>
  </div>
  <div id="fp-tn" style="display:none;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:9px;padding:7px 11px;margin-bottom:7px;font-size:13px;font-weight:600;color:var(--yellow)"></div>
  <div class="fp-btns">
    <button class="fp-nav" onclick="navFP()">üó∫Ô∏è Navigate NOW</button>
    <button class="fp-call" onclick="callFP()">üìû</button>
  </div>
</div>

<!-- PHOTO VIEWER -->
<div class="pview" id="pview">
  <button class="pvx" onclick="document.getElementById('pview').classList.remove('show')">‚úï Close</button>
  <img id="pvimg" src="" alt="">
  <div style="color:var(--tx2);font-size:13px;margin-top:10px;padding:0 20px;text-align:center" id="pvnm"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr active" id="scr-home">

  <!-- MAP ‚Äî SATELLITE -->
  <div class="stitle" style="margin-top:0">üõ∞Ô∏è Satellite Map</div>
  <div style="background:var(--s);border:1px solid var(--br);border-radius:14px;padding:12px;margin-bottom:12px">
    <div id="map"></div>
    <div class="rpbar"><div class="rpfill" id="rp" style="width:0%"></div></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
      <div>
        <span style="font-size:13px;color:var(--tx2)" id="rtxt">0 pending</span>
        <span style="font-size:12px;color:var(--teal);margin-left:6px" id="km-txt"></span>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-gh btn-sm" onclick="openSelectModal()" style="font-size:12px">‚òë Select Aaj ke</button>
        <button class="btn btn-g btn-sm" onclick="startRoute()">‚ñ∂ Start</button>
      </div>
    </div>
  </div>

  <!-- TODAY SELECTED BAR -->
  <div id="today-bar" style="display:none">
    <div class="today-bar">
      <div class="today-bar-info">
        <div class="today-bar-title" id="today-title">0 parcels aaj ke liye</div>
        <div class="today-bar-sub">Sirf inhi ka route chalega ‚Ä¢ Map pe green</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-g btn-sm" onclick="startRoute()">‚ñ∂ Start</button>
        <button class="btn btn-gh btn-sm" onclick="clearToday()">‚úï</button>
      </div>
    </div>
  </div>

  <!-- CURRENT DELIVERY -->
  <div id="cur-wrap" style="display:none">
    <div class="stitle">üöö Abhi Deliver Karo</div>
    <div class="cur-card">
      <div style="display:flex;align-items:center;gap:11px;margin-bottom:10px">
        <div class="cur-photo" id="cur-ph">üì¶</div>
        <div style="flex:1;min-width:0">
          <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:700;background:linear-gradient(135deg,#60A5FA,#A78BFA);-webkit-background-clip:text;-webkit-text-fill-color:transparent" id="cur-nm"></div>
          <div style="font-size:12px;color:var(--tx2)" id="cur-tel"></div>
          <div style="font-size:12px;color:var(--tx3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" id="cur-ad"></div>
        </div>
      </div>
      <div id="cur-tn" style="display:none;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:9px;padding:8px 11px;margin-bottom:10px;font-size:13px;font-weight:600;color:var(--yellow)"></div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-p" style="flex:2;padding:10px" onclick="navCur()">üó∫Ô∏è Navigate</button>
        <button class="btn btn-g" style="flex:2;padding:10px" onclick="delCur()">‚úì Delivered</button>
        <button class="btn btn-gh btn-sm" onclick="callCur()" style="padding:10px 12px;flex:1">üìû</button>
      </div>
    </div>
  </div>

  <!-- PENDING LIST -->
  <div class="stitle">üì¶ Pending Parcels</div>
  <div id="home-list"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARCELS SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr" id="scr-parcels">
  <div class="sbar">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:17px;height:17px;color:var(--tx3);flex-shrink:0"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" placeholder="Naam, phone, barcode, address..." id="srch" oninput="renderParcels()">
  </div>
  <div class="ftabs">
    <button class="ftab on" onclick="setF(this,'all')">Sab</button>
    <button class="ftab" onclick="setF(this,'today')">‚úÖ Aaj ke</button>
    <button class="ftab" onclick="setF(this,'pending')">Pending</button>
    <button class="ftab" onclick="setF(this,'timed')">‚è∞ Timed</button>
    <button class="ftab" onclick="setF(this,'photos')">üì∏ Photos</button>
    <button class="ftab" onclick="setF(this,'done')">Done</button>
  </div>
  <div id="plist"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCAN SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr" id="scr-scan">
  <div class="scan-tabs">
    <button class="stab on" id="tab-bc" onclick="setScanMode('bc',this)">üì∑ Barcode / QR</button>
    <button class="stab" id="tab-ocr" onclick="setScanMode('ocr',this)">üî§ Naam / Text Scan</button>
  </div>

  <!-- BARCODE -->
  <div id="mode-bc">
    <div class="stitle" style="margin-top:0">Barcode ya QR Code</div>
    <div style="background:var(--s);border:1px solid var(--br);border-radius:14px;padding:14px;margin-bottom:12px">
      <div class="scanbox">
        <video id="scan-vid" playsinline muted autoplay></video>
        <div class="scanov"><div class="scanfr"><div class="scanln"></div></div></div>
      </div>
      <p style="text-align:center;color:var(--tx2);font-size:13px;margin-top:10px">Parcel ka barcode ya QR scan karo</p>
      <div id="scan-res" style="display:none;margin-top:12px">
        <div style="background:var(--s2);border-radius:9px;padding:11px;border:1px solid var(--br)">
          <div style="font-size:11px;color:var(--tx2);margin-bottom:3px">Scanned:</div>
          <div id="scan-code" style="font-weight:700;font-size:16px;letter-spacing:1px;color:var(--blue)"></div>
        </div>
        <div id="scan-match" style="margin-top:10px"></div>
        <button class="btn btn-p" style="margin-top:10px" onclick="addFromScan()">+ Add as New Parcel</button>
      </div>
    </div>
    <div style="background:var(--s);border:1px solid var(--br);border-radius:14px;padding:14px">
      <div class="fl">Manual Barcode</div>
      <div style="display:flex;gap:8px">
        <input type="text" class="fi" id="man-bc" placeholder="Barcode enter karo..." style="flex:1">
        <button class="btn btn-p btn-sm" onclick="manSearch()">Search</button>
      </div>
    </div>
  </div>

  <!-- OCR -->
  <div id="mode-ocr" style="display:none">
    <div class="stitle" style="margin-top:0">üì∑ Camera se Naam Scan</div>
    <div style="background:var(--s);border:1px solid var(--br);border-radius:14px;padding:14px;margin-bottom:12px">
      <p style="font-size:13px;color:var(--tx2);margin-bottom:12px">Parcel ke upar likha naam ya address photo lo ‚Äî app automatically parcel dhundh lega aur aaj ke route mein add kar dega!</p>
      <button class="btn btn-p" onclick="document.getElementById('ocr-inp').click()">üì∏ Camera se Scan Karo</button>
      <input type="file" id="ocr-inp" accept="image/*" capture="environment" style="display:none" onchange="doOCR(event)">
      <div class="ocr-box" id="ocr-box">
        <div style="font-size:13px;font-weight:600" id="ocr-msg">Text padhh raha hai...</div>
        <div class="obar"><div class="ofill" id="ocr-fill"></div></div>
        <div style="font-size:12px;color:var(--tx2)" id="ocr-txt"></div>
      </div>
    </div>
    <div style="background:var(--s);border:1px solid var(--br);border-radius:14px;padding:14px">
      <div class="fl">Manual Naam / Address Search</div>
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input type="text" class="fi" id="ocr-man" placeholder="Naam ya address type karo..." style="flex:1">
        <button class="btn btn-p btn-sm" onclick="ocrManS()">Search</button>
      </div>
      <div id="ocr-res"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BACKUP SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr" id="scr-io">
  <div class="stitle" style="margin-top:0">‚òÅÔ∏è Google Drive</div>
  <div style="background:var(--s);border:1px solid var(--br);border-radius:14px;padding:14px;margin-bottom:12px">
    <div id="drive-off">
      <p style="font-size:13px;color:var(--tx2);margin-bottom:13px">Login karo ‚Äî sab data + photos automatically Drive mein save honge! Mobile badlo toh sirf login karo, sab wapas! üîÑ</p>
      <button class="btn btn-p" onclick="gLogin()">
        <img src="https://www.google.com/favicon.ico" style="width:17px;height:17px"> Google se Login karo
      </button>
    </div>
    <div id="drive-on" style="display:none">
      <div style="display:flex;align-items:center;gap:11px;margin-bottom:13px">
        <div style="font-size:28px">‚òÅÔ∏è</div>
        <div style="flex:1">
          <div style="font-weight:700" id="drv-nm">Connected</div>
          <div style="font-size:12px;color:var(--tx2)" id="drv-st">Ready</div>
        </div>
        <button class="btn btn-g btn-sm" onclick="syncDrive()">‚Üë Sync</button>
      </div>
      <button class="btn btn-p" style="margin-bottom:8px" onclick="syncDrive()">‚òÅÔ∏è Drive mein Save karo</button>
      <button class="btn btn-gh" style="margin-bottom:8px" onclick="loadDrive()">‚¨áÔ∏è Drive se Load karo</button>
      <button class="btn btn-gh" style="font-size:13px" onclick="gLogout()">üö™ Logout</button>
    </div>
  </div>

  <div class="stitle">üíæ Local Backup</div>
  <div style="background:var(--s);border:1px solid var(--br);border-radius:14px;padding:14px;margin-bottom:12px">
    <button class="biobtn" onclick="exportJSON()"><div class="bioic" style="background:rgba(59,130,246,0.15)">üíæ</div><div><div style="font-weight:600">JSON Backup Export</div><div style="font-size:12px;color:var(--tx2)">Sab data + photos</div></div></button>
    <button class="biobtn" onclick="exportCSV()"><div class="bioic" style="background:rgba(16,185,129,0.15)">üìä</div><div><div style="font-weight:600">CSV Export (Excel)</div><div style="font-size:12px;color:var(--tx2)">Report ke liye</div></div></button>
    <button class="biobtn" onclick="document.getElementById('imp-f').click()"><div class="bioic" style="background:rgba(245,158,11,0.15)">üìÇ</div><div><div style="font-weight:600">Import / Restore</div><div style="font-size:12px;color:var(--tx2)">JSON backup file select karo</div></div></button>
    <input type="file" id="imp-f" accept=".json,.txt,application/json,text/*" style="display:none" onchange="doImport(event)">
    <button class="biobtn" onclick="waBackup()"><div class="bioic" style="background:rgba(37,211,102,0.15)">üí¨</div><div><div style="font-weight:600">WhatsApp Backup</div><div style="font-size:12px;color:var(--tx2)">Apne aap ko bhejo</div></div></button>
  </div>

  <div class="stitle">üì§ Share</div>
  <div style="background:var(--s);border:1px solid var(--br);border-radius:14px;padding:14px;margin-bottom:12px">
    <div style="background:var(--s2);border-radius:9px;padding:10px;margin-bottom:11px;font-size:13px;color:var(--blue);word-break:break-all" id="app-url"></div>
    <button class="btn btn-p" onclick="shareApp()">üì§ Share App Link</button>
  </div>

  <div class="stitle">Info</div>
  <div style="background:var(--s);border:1px solid var(--br);border-radius:14px;padding:14px;margin-bottom:12px"><div id="stinfo"></div></div>

  <div class="stitle" style="color:var(--red)">Danger</div>
  <div style="background:var(--s);border:1px solid var(--br);border-radius:14px;padding:14px">
    <button class="btn btn-r" onclick="clearAll()">üóëÔ∏è Clear All Data</button>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="nav">
  <button class="nb active" onclick="goScr('home',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>Home
  </button>
  <button class="nb" onclick="goScr('parcels',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="18" rx="2"/><path d="M8 10h8M8 14h5"/></svg>Parcels
  </button>
  <button class="nb" onclick="goScr('scan',this);startScanner()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><path d="M14 14h2v2h-2zM18 14h3v2h-3zM14 18h3v2h-3zM18 18h3v3h-3z"/></svg>Scan
  </button>
  <button class="nb" onclick="goScr('io',this);updIO()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Backup
  </button>
</nav>

<!-- ADD/EDIT MODAL -->
<div class="mov" id="add-mod">
  <div class="mod">
    <div class="mhnd"></div>
    <div class="mtit" id="mod-tit">Add New Parcel</div>
    <input type="hidden" id="eid">
    <div class="fg"><label class="fl">Customer Name *</label><input type="text" class="fi" id="fn" placeholder="e.g. Rahul Kumar"></div>
    <div class="fg"><label class="fl">Phone Number</label><input type="tel" class="fi" id="fph" placeholder="9876543210"></div>
    <div class="fg">
      <label class="fl">Barcode / Tracking ID</label>
      <div style="display:flex;gap:7px">
        <input type="text" class="fi" id="fbc" placeholder="Scan ya enter karein" style="flex:1">
        <button class="btn btn-gh btn-sm" onclick="scanForm()">üì∑</button>
      </div>
    </div>
    <div class="fg"><label class="fl">Delivery Address</label><textarea class="fi" id="fad" placeholder="Full address..."></textarea></div>
    <div class="tsec">
      <div style="font-size:13px;font-weight:700;color:var(--yellow);margin-bottom:9px">‚è∞ Delivery Time Note</div>
      <div class="tpres">
        <button class="tp" onclick="setTP(this,'Subah 9 baje ke baad')">9 AM+</button>
        <button class="tp" onclick="setTP(this,'Sirf 12 baje dena')">12 Baje sirf</button>
        <button class="tp" onclick="setTP(this,'Dopahar 2-4 baje')">2-4 PM</button>
        <button class="tp" onclick="setTP(this,'Shaam 5 baje ke baad')">5 PM+</button>
        <button class="tp" onclick="setTP(this,'Raat 7-9 baje')">7-9 PM</button>
        <button class="tp" onclick="setTP(this,'Pehle call karna zaroori')">Call First!</button>
      </div>
      <input type="text" class="fi" id="ftn" placeholder="Custom time note...">
    </div>
    <div style="margin-bottom:13px">
      <label class="fl">üì∏ Ghar Ki Photo (Auto-compressed ~50-100KB)</label>
      <div class="pgrid" id="fpgrid"></div>
      <input type="file" id="ph-inp" accept="image/*" capture="environment" style="display:none" onchange="gotPhoto(event)">
      <p style="font-size:11px;color:var(--tx3);margin-top:6px">üí° Darwaza, naam plate ya pehchaan ki cheez ki photo lo</p>
    </div>
    <div class="fg"><label class="fl">Notes</label><input type="text" class="fi" id="fno" placeholder="Koi aur info..."></div>
    <!-- LOCATION -->
    <div style="border:1px solid var(--br);border-radius:11px;overflow:hidden;margin-bottom:13px">
      <div style="padding:11px 13px;background:var(--s2);display:flex;align-items:center;justify-content:space-between">
        <div><div style="font-weight:600;font-size:14px">üìç Exact Location</div><div id="loc-d" style="font-size:12px;color:var(--tx2);margin-top:2px">Set nahi hai</div></div>
        <button class="btn btn-gh btn-sm" onclick="openLP()">Map pe Pick karo</button>
      </div>
      <div id="mmap-w" style="display:none;height:130px"><div id="mmap" style="height:100%"></div></div>
    </div>
    <!-- LOCK -->
    <div style="display:flex;align-items:center;justify-content:space-between;background:var(--s2);border:1px solid var(--br);border-radius:11px;padding:11px 13px;margin-bottom:13px">
      <div><div style="font-weight:600;font-size:14px">üîí Location Lock</div><div style="font-size:12px;color:var(--tx2);margin-top:1px">Permanently save karo</div></div>
      <button class="tog" id="ltog" onclick="this.classList.toggle('on')"></button>
    </div>
    <div style="display:flex;gap:9px">
      <button class="btn btn-gh" onclick="closeMod('add-mod')" style="flex:1">Cancel</button>
      <button class="btn btn-p" onclick="saveParcel()" style="flex:2">üíæ Save Parcel</button>
    </div>
  </div>
</div>

<!-- SELECT MODAL -->
<div class="mov" id="sel-mod">
  <div class="mod">
    <div class="mhnd"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
      <div class="mtit" style="margin-bottom:0">‚òë Aaj ke Parcels Select karo</div>
      <button class="btn btn-gh btn-sm" onclick="selAll()">Select All</button>
    </div>
    <p style="font-size:13px;color:var(--tx2);margin-bottom:13px">Select karo ‚Äî route sirf inhi ka lagega!</p>
    <div id="sel-list" style="max-height:55vh;overflow-y:auto"></div>
    <div style="display:flex;gap:9px;margin-top:13px">
      <button class="btn btn-gh" onclick="closeMod('sel-mod')" style="flex:1">Cancel</button>
      <button class="btn btn-g" onclick="confirmSel()" style="flex:2">‚úÖ Route Banao (<span id="sel-cnt">0</span>)</button>
    </div>
  </div>
</div>

<!-- LOCATION PICKER -->
<div class="lmod" id="lmod">
  <div class="lhdr">
    <button class="btn btn-gh btn-sm" onclick="closeLP()">‚úï</button>
    <div style="flex:1;font-family:'Syne',sans-serif;font-weight:700;font-size:16px;text-align:center">üìç Exact Location Pick karo</div>
    <button class="btn btn-p btn-sm" onclick="confirmLoc()">‚úì Confirm</button>
  </div>
  <div class="lmap">
    <div id="lpmap"></div>
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-100%);font-size:38px;pointer-events:none;z-index:1000;filter:drop-shadow(0 3px 8px rgba(0,0,0,0.7))">üìç</div>
    <button onclick="myGPS()" style="position:absolute;bottom:14px;right:14px;z-index:1000;background:linear-gradient(135deg,#3B82F6,#6366F1);border:none;color:#fff;border-radius:11px;padding:11px 15px;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:700;font-size:13px;box-shadow:0 4px 16px rgba(59,130,246,0.4)">üì° Meri Exact Location</button>
  </div>
  <div class="lbot">
    <div class="gbox" id="gbox"><div class="gdot"></div><div style="flex:1"><div style="font-size:13px;font-weight:600" id="gbox-t"></div><div style="font-size:11px;color:var(--tx2)" id="gbox-s"></div></div></div>
    <div style="font-size:11px;color:var(--tx2);margin-bottom:3px">Selected Location:</div>
    <div id="lp-addr" style="font-size:14px;font-weight:500">Map drag karo ya GPS tap karo</div>
    <div id="lp-coord" style="font-size:11px;color:var(--tx3);margin-top:2px;font-family:monospace"></div>
    <div style="font-size:11px;color:var(--tx3);margin-top:6px">üí° Ghar ke DARWAZE pe pin lagao ‚Äî bilkul exact!</div>
  </div>
</div>

<!-- FORM SCANNER -->
<div class="mov" id="fscan-mod">
  <div class="mod">
    <div class="mhnd"></div>
    <div class="mtit">üì∑ Barcode Scan karo</div>
    <div class="scanbox" style="max-width:100%">
      <video id="fscan-vid" playsinline muted autoplay></video>
      <div class="scanov"><div class="scanfr"><div class="scanln"></div></div></div>
    </div>
    <button class="btn btn-gh" style="margin-top:11px" onclick="closeFormScan()">Cancel</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CLIENT_ID = '451433224086-bdq3pmnl1di14kmia8r4hvtjhcmaf3gq.apps.googleusercontent.com';
const DRIVE_FILE = 'deliverpro_backup.json';
const REDIRECT = window.location.origin + window.location.pathname;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let P = [];           // all parcels
let todayIds = new Set();   // selected for today's route
let tempIds = new Set();    // temp during modal
let filt = 'all';
let selId = null;     // floating parcel
let curIdx = 0;
let routeOn = false;
let routeKm = 0;
let routeStartTime = null;

let hMap = null, pMap = null, mMap = null, mMark = null;
let selLat = null, selLng = null;
let zxR = null, zxFR = null, scanOn = false;
let proxWid = null;
let fPhotos = [];
let gTok = null, gUser = null, driveId = null;
let scanMode = 'bc';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function save() {
  try {
    localStorage.setItem('dp8', JSON.stringify(P));
    localStorage.setItem('dp8_today', JSON.stringify([...todayIds]));
  } catch(e) {
    // Storage full! Photos hata ke try karo
    if(e.name === 'QuotaExceededError' || e.code === 22) {
      try {
        // Photos ke bina save karo
        const slim = P.map(p => ({...p, photos:[]}));
        localStorage.setItem('dp8', JSON.stringify(slim));
        localStorage.setItem('dp8_today', JSON.stringify([...todayIds]));
        showT('‚ö†Ô∏è Storage full! Photos Drive mein safe hain', 'err');
        // Auto sync to Drive if logged in
        if(gTok) setTimeout(syncDrive, 1000);
      } catch(e2) {
        showT('‚ùå Storage bilkul full! Drive sync karo', 'err');
        if(gTok) setTimeout(syncDrive, 500);
      }
    }
  }
  updStats();
}

function load() {
  try { P = JSON.parse(localStorage.getItem('dp8') || '[]'); } catch { P = []; }

  // Purane versions se migrate karo
  if(P.length === 0) {
    const oldKeys = ['dp7', 'dp6', 'parcels', 'deliveryParcels'];
    for(const key of oldKeys) {
      try {
        const old = localStorage.getItem(key);
        if(old) {
          const parsed = JSON.parse(old);
          const arr = Array.isArray(parsed) ? parsed : (parsed.parcels || []);
          if(arr.length > 0) {
            P = arr;
            try { localStorage.setItem('dp8', JSON.stringify(P)); } catch {}
            break;
          }
        }
      } catch {}
    }
  }

  gTok = localStorage.getItem('dp8_tok') || null;
  driveId = localStorage.getItem('dp8_did') || null;
  try { gUser = JSON.parse(localStorage.getItem('dp8_user') || 'null'); } catch { gUser = null; }
  try { todayIds = new Set(JSON.parse(localStorage.getItem('dp8_today') || '[]')); } catch { todayIds = new Set(); }
}
function save() {
  localStorage.setItem('dp8', JSON.stringify(P));
  localStorage.setItem('dp8_today', JSON.stringify([...todayIds]));
  updStats();
}
function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2,5); }

function updStats() {
  document.getElementById('s0').textContent = P.length;
  document.getElementById('s1').textContent = P.filter(p=>!p.delivered).length;
  document.getElementById('s2').textContent = P.filter(p=>p.delivered).length;
  document.getElementById('s3').textContent = [...todayIds].filter(id=>!P.find(p=>p.id===id)?.delivered).length;
  document.getElementById('s4').textContent = P.filter(p=>p.timeNote&&!p.delivered).length;
  document.getElementById('s5').textContent = P.filter(p=>p.photos&&p.photos.length>0).length;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE DRIVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gLogin() {
  if(gTok) { gLogout(); return; }
  const url = 'https://accounts.google.com/o/oauth2/v2/auth?' + new URLSearchParams({
    client_id: CLIENT_ID,
    redirect_uri: REDIRECT,
    response_type: 'token',
    scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
    include_granted_scopes: 'true'
  });
  window.location.href = url;
}
function gLogout() {
  if(!confirm('Logout karein?')) return;
  gTok = null; gUser = null; driveId = null;
  ['dp8_tok','dp8_user','dp8_did'].forEach(k=>localStorage.removeItem(k));
  updGBar(false); showT('Logged out', 'err');
}
async function checkAuth() {
  const hash = window.location.hash;
  if(!hash.includes('access_token')) return;
  const p = new URLSearchParams(hash.substring(1));
  const tok = p.get('access_token');
  if(!tok) return;
  window.history.replaceState({}, document.title, window.location.pathname);
  gTok = tok; localStorage.setItem('dp8_tok', tok);
  await fetchGUser();
  updGBar(true);
  showT('‚úÖ Google login ho gaya!', 'ok');
  setTimeout(syncDrive, 1500);
}
async function fetchGUser() {
  try {
    const r = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers: { Authorization: 'Bearer ' + gTok } });
    gUser = await r.json();
    localStorage.setItem('dp8_user', JSON.stringify(gUser));
  } catch {}
}
function updGBar(on) {
  const bar = document.getElementById('gbar');
  const av = document.getElementById('gav');
  if(on && gUser) {
    bar.className = 'gbar on';
    av.innerHTML = gUser.picture ? `<img src="${gUser.picture}">` : (gUser.name||'U')[0];
    document.getElementById('gnm').textContent = gUser.name || 'Connected';
    document.getElementById('gsb').textContent = gUser.email || 'Drive sync active';
    document.getElementById('gact').textContent = '‚úÖ Synced'; document.getElementById('gact').className = 'gact on';
    document.getElementById('drive-off').style.display = 'none';
    document.getElementById('drive-on').style.display = 'block';
    if(document.getElementById('drv-nm')) document.getElementById('drv-nm').textContent = gUser.name||'';
  } else {
    bar.className = 'gbar'; av.textContent = 'G';
    document.getElementById('gnm').textContent = 'Google se Login karo';
    document.getElementById('gsb').textContent = 'Data + Photos Drive mein save honge';
    document.getElementById('gact').textContent = 'Login ‚Üí'; document.getElementById('gact').className = 'gact';
    document.getElementById('drive-off').style.display = 'block';
    document.getElementById('drive-on').style.display = 'none';
  }
}
async function syncDrive() {
  if(!gTok) { showT('Pehle login karo', 'err'); return; }
  document.getElementById('drv-st').textContent = 'Saving...';
  document.getElementById('gact').textContent = '‚Üë Syncing...';
  try {
    const body = JSON.stringify({ version:8, savedAt:new Date().toISOString(), parcels:P, todayIds:[...todayIds] }, null, 2);
    if(driveId) {
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveId}?uploadType=media`, { method:'PATCH', headers:{Authorization:'Bearer '+gTok,'Content-Type':'application/json'}, body });
    } else {
      const m = await fetch('https://www.googleapis.com/drive/v3/files', { method:'POST', headers:{Authorization:'Bearer '+gTok,'Content-Type':'application/json'}, body:JSON.stringify({name:DRIVE_FILE,mimeType:'application/json'}) });
      const mj = await m.json(); driveId = mj.id; localStorage.setItem('dp8_did', driveId);
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveId}?uploadType=media`, { method:'PATCH', headers:{Authorization:'Bearer '+gTok,'Content-Type':'application/json'}, body });
    }
    const now = new Date().toLocaleTimeString('hi-IN');
    document.getElementById('drv-st').textContent = 'Last sync: ' + now;
    document.getElementById('gact').textContent = '‚úÖ Synced'; document.getElementById('gact').className = 'gact on';
    showT('‚òÅÔ∏è Drive mein save ho gaya!', 'ok');
  } catch { document.getElementById('drv-st').textContent = 'Sync failed'; showT('Drive sync failed', 'err'); }
}
async function loadDrive() {
  if(!gTok) { showT('Pehle login karo', 'err'); return; }
  showT('Loading from Drive...', '');
  try {
    const sr = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${DRIVE_FILE}'&spaces=drive&fields=files(id)`, { headers:{Authorization:'Bearer '+gTok} });
    const sj = await sr.json();
    if(!sj.files||sj.files.length===0) { showT('Drive mein backup nahi mila', 'err'); return; }
    driveId = sj.files[0].id; localStorage.setItem('dp8_did', driveId);
    const fr = await fetch(`https://www.googleapis.com/drive/v3/files/${driveId}?alt=media`, { headers:{Authorization:'Bearer '+gTok} });
    const fd = await fr.json();
    const imp = fd.parcels || fd;
    if(!Array.isArray(imp)) { showT('Invalid file', 'err'); return; }
    const ex = new Set(P.map(p=>p.id)); let n=0;
    imp.forEach(p=>{ if(!ex.has(p.id)) { P.push(p); n++; } });
    if(fd.todayIds) fd.todayIds.forEach(id=>todayIds.add(id));
    save(); renderHome(); renderParcels();
    showT(`‚úÖ ${n} parcels Drive se load hue!`, 'ok');
  } catch { showT('Load failed', 'err'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHOTO ‚Äî COMPRESSED ~50-100KB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function compressPhoto(file, cb) {
  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const max = 600;
      let w = img.width, h = img.height;
      if(w>max||h>max) { if(w>h){h=Math.round(h*max/w);w=max;}else{w=Math.round(w*max/h);h=max;} }
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      cb(canvas.toDataURL('image/jpeg', 0.6));
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
}
function gotPhoto(e) {
  const file = e.target.files[0]; if(!file) return;
  compressPhoto(file, data => {
    fPhotos.push({ id:uid(), data, at:new Date().toISOString() });
    renderFGrid(); showT(`üì∏ Photo added (~${Math.round(data.length*0.75/1024)}KB)`, 'ok');
  });
  e.target.value='';
}
function renderFGrid() {
  const g = document.getElementById('fpgrid'); g.innerHTML='';
  fPhotos.forEach((ph,i)=>{
    const d=document.createElement('div'); d.className='pth2';
    d.innerHTML=`<img src="${ph.data}" onclick="showPhoto('${ph.data}','Photo ${i+1}')"><button class="pdel" onclick="fPhotos.splice(${i},1);renderFGrid();event.stopPropagation()">‚úï</button>`;
    g.appendChild(d);
  });
  const ab=document.createElement('div'); ab.className='padd'; ab.onclick=()=>document.getElementById('ph-inp').click();
  ab.innerHTML=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:22px;height:22px"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>Photo Lo`;
  g.appendChild(ab);
}
function addPhotoToP(id) {
  const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.capture='environment';
  inp.onchange=e=>{
    const file=e.target.files[0]; if(!file)return;
    compressPhoto(file, data=>{
      const idx=P.findIndex(p=>p.id===id);
      if(idx!==-1){ if(!P[idx].photos)P[idx].photos=[];P[idx].photos.push({id:uid(),data,at:new Date().toISOString()});save();renderParcels();if(gTok)setTimeout(syncDrive,2000);showT(`üì∏ Photo saved (~${Math.round(data.length*0.75/1024)}KB)`,'ok'); }
    });
  };
  inp.click();
}
function showPhoto(src, nm) { document.getElementById('pvimg').src=src; document.getElementById('pvnm').textContent=nm; document.getElementById('pview').classList.add('show'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TODAY SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSelectModal() {
  tempIds = new Set(todayIds);
  document.getElementById('sel-mod').classList.add('active');
  renderSelList();
}
function renderSelList() {
  const pend = P.filter(p=>!p.delivered);
  const el = document.getElementById('sel-list');
  if(pend.length===0){ el.innerHTML='<div class="empty"><div>üì≠</div><div>Koi pending parcel nahi</div></div>'; return; }
  el.innerHTML = pend.map(p => {
    const on = tempIds.has(p.id);
    const urg = p.timeNote && isUrg(p.timeNote);
    const hasPh = p.photos && p.photos.length>0;
    return `<div class="sel-item" onclick="toggleTemp('${p.id}')">
      <div class="selbox ${on?'on':''}">${on?'<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" style="width:13px;height:13px"><polyline points="20 6 9 17 4 12"/></svg>':''}</div>
      <div style="width:40px;height:40px;border-radius:9px;overflow:hidden;background:var(--s2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:18px;border:1px solid var(--br)">
        ${hasPh?`<img src="${p.photos[0].data}" style="width:100%;height:100%;object-fit:cover">`:'üì¶'}
      </div>
      <div style="flex:1;min-width:0">
        <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;background:linear-gradient(135deg,${on?'#34D399,#60A5FA':'#60A5FA,#A78BFA'});-webkit-background-clip:text;-webkit-text-fill-color:transparent">${p.name}</div>
        <div style="font-size:12px;color:var(--tx2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.phone||''} ${p.address?'‚Ä¢ '+p.address:''}</div>
        ${p.timeNote?`<div style="font-size:11px;color:${urg?'var(--red)':'var(--yellow)'}">‚è∞ ${p.timeNote}</div>`:''}
        <div style="font-size:10px;color:${p.lat?'var(--green)':'var(--tx3)'};margin-top:2px">${p.lat?'üìç Location set':'‚ö†Ô∏è Location nahi'}</div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('sel-cnt').textContent = tempIds.size;
}
function toggleTemp(id) { if(tempIds.has(id))tempIds.delete(id);else tempIds.add(id); renderSelList(); }
function selAll() {
  const pend=P.filter(p=>!p.delivered);
  if(tempIds.size===pend.length)tempIds.clear(); else pend.forEach(p=>tempIds.add(p.id));
  renderSelList();
}
function confirmSel() {
  todayIds = new Set(tempIds);
  save(); closeMod('sel-mod');
  const bar=document.getElementById('today-bar');
  if(todayIds.size>0){
    bar.style.display='block';
    document.getElementById('today-title').textContent=todayIds.size+' parcels aaj ke liye selected';
  } else bar.style.display='none';
  renderMap(); renderHome();
  showT(`‚úÖ ${todayIds.size} parcels selected!`,'ok');
  // Auto start route
  if(todayIds.size>0) setTimeout(startRoute, 500);
}
function clearToday() { todayIds.clear(); save(); document.getElementById('today-bar').style.display='none'; routeOn=false; document.getElementById('cur-wrap').style.display='none'; renderMap(); renderHome(); showT('Selection clear',''); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SATELLITE MAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initHMap() {
  if(hMap) return;
  hMap = L.map('map', { zoomControl:true, attributionControl:false });
  // SATELLITE ‚Äî hamesha
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom:19 }).addTo(hMap);
  hMap.setView([28.6139,77.2090], 12);
}

function renderHome() { initHMap(); renderMap(); renderHomeList(); updCurCard(); }

function renderMap() {
  if(!hMap) return;
  hMap.eachLayer(l=>{ if(l instanceof L.Marker||l instanceof L.Polyline) hMap.removeLayer(l); });

  // Which parcels to show on map
  const toShow = todayIds.size>0
    ? P.filter(p=>todayIds.has(p.id)&&!p.delivered&&p.lat&&p.lng)
    : P.filter(p=>!p.delivered&&p.lat&&p.lng);

  const tot=P.filter(p=>p.lat&&p.lng).length;
  const dn=P.filter(p=>p.delivered&&p.lat&&p.lng).length;
  document.getElementById('rp').style.width=(tot>0?(dn/tot*100):0)+'%';
  document.getElementById('rtxt').textContent=P.filter(p=>!p.delivered).length+' pending';
  document.getElementById('km-txt').textContent=routeKm>0?`‚Ä¢ ~${routeKm.toFixed(1)}km`:'';

  const pts=[];
  toShow.forEach((p,i)=>{
    const urg=p.timeNote&&isUrg(p.timeNote);
    const isToday=todayIds.has(p.id);
    const isCur=routeOn&&i===0;
    const hasPh=p.photos&&p.photos.length>0;
    const col=urg?'#EF4444':isCur?'#F59E0B':isToday?'#10B981':'#3B82F6';
    const icon=L.divIcon({
      html:`<div onclick="setFP('${p.id}')" style="background:${col};color:#fff;border-radius:50%;width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px;border:3px solid rgba(255,255,255,0.9);box-shadow:0 2px 12px rgba(0,0,0,0.6);cursor:pointer;font-family:Syne,sans-serif">${hasPh?'üì∏':urg?'‚ö†':(i+1)}</div>`,
      className:'',iconSize:[34,34],iconAnchor:[17,17]
    });
    L.marker([p.lat,p.lng],{icon}).addTo(hMap).on('click',()=>setFP(p.id));
    pts.push([p.lat,p.lng]);
  });
  if(pts.length>1) L.polyline(pts,{color:'#00FF88',weight:3,opacity:0.8,dashArray:'8,5'}).addTo(hMap);
  if(pts.length>0) hMap.fitBounds(L.latLngBounds(pts),{padding:[30,30]});
}

function renderHomeList() {
  const pend=getPend();
  const el=document.getElementById('home-list');
  if(pend.length===0){el.innerHTML='<div class="empty"><div>üéâ</div><div>Sab deliver ho gaye!</div></div>';return;}
  el.innerHTML=pend.slice(0,6).map((p,i)=>pCard(p,i+1,routeOn&&i===0,false)).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROUTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getPend() {
  let list = todayIds.size>0&&routeOn
    ? P.filter(p=>todayIds.has(p.id)&&!p.delivered)
    : P.filter(p=>!p.delivered);
  return list.sort((a,b)=>{
    const aU=a.timeNote&&isUrg(a.timeNote),bU=b.timeNote&&isUrg(b.timeNote);
    if(aU&&!bU)return -1; if(!aU&&bU)return 1;
    if(a.routeOrder!==undefined&&b.routeOrder!==undefined)return a.routeOrder-b.routeOrder;
    if(a.lat&&!b.lat)return -1; if(!a.lat&&b.lat)return 1;
    return 0;
  });
}

async function startRoute() {
  const toRoute = todayIds.size>0
    ? P.filter(p=>todayIds.has(p.id)&&!p.delivered)
    : P.filter(p=>!p.delivered);
  if(toRoute.length===0){showT('Koi parcel nahi!','err');return;}
  showT('üîÑ Smart route bana raha hai...','');
  await optRoute(toRoute);
  routeOn=true; curIdx=0; routeStartTime=Date.now();
  renderHome();
  showT(`üöÄ Route ready! ${toRoute.filter(p=>p.lat).length} stops ~${routeKm.toFixed(1)}km`,'ok');
}

async function optRoute(pend) {
  const wL=pend.filter(p=>p.lat&&p.lng), nL=pend.filter(p=>!p.lat||!p.lng);
  if(wL.length<=1){pend.forEach((p,i)=>p.routeOrder=i);save();return;}

  // Get current GPS
  let sLat=null,sLng=null;
  try{await new Promise(res=>navigator.geolocation.getCurrentPosition(pos=>{sLat=pos.coords.latitude;sLng=pos.coords.longitude;res();},()=>res(),{timeout:3000,enableHighAccuracy:true}));}catch{}

  const urgent=wL.filter(p=>p.timeNote&&isUrg(p.timeNote));
  const normal=wL.filter(p=>!p.timeNote||!isUrg(p.timeNote));

  const nn=(list,fLat,fLng)=>{
    if(!list.length)return[];
    let uv=[...list],ord=[];
    if(fLat&&fLng){let best=uv[0],md=dk(fLat,fLng,uv[0].lat,uv[0].lng);for(const p of uv){const d=dk(fLat,fLng,p.lat,p.lng);if(d<md){md=d;best=p;}}uv=uv.filter(p=>p!==best);ord.push(best);}
    else ord.push(uv.shift());
    while(uv.length>0){const c=ord[ord.length-1];let best=null,md=Infinity;for(const p of uv){const d=dk(c.lat,c.lng,p.lat,p.lng);if(d<md){md=d;best=p;}}uv=uv.filter(p=>p!==best);ord.push(best);}
    return ord;
  };

  let oU=nn(urgent,sLat,sLng);
  const last=oU.length?oU[oU.length-1]:null;
  let oN=twoOpt(nn(normal,last?.lat||sLat,last?.lng||sLng));
  const final=[...oU,...oN,...nL];
  final.forEach((p,i)=>p.routeOrder=i);

  routeKm=0;
  for(let i=0;i<final.length-1;i++)if(final[i].lat&&final[i+1].lat)routeKm+=dk(final[i].lat,final[i].lng,final[i+1].lat,final[i+1].lng);
  save();
}

function twoOpt(r){
  if(r.length<4)return r;
  let best=[...r],imp=true,it=0;
  while(imp&&it<50){imp=false;it++;
    for(let i=1;i<best.length-2;i++)for(let j=i+1;j<best.length-1;j++){
      const d1=dk(best[i-1].lat,best[i-1].lng,best[i].lat,best[i].lng)+dk(best[j].lat,best[j].lng,best[j+1].lat,best[j+1].lng);
      const d2=dk(best[i-1].lat,best[i-1].lng,best[j].lat,best[j].lng)+dk(best[i].lat,best[i].lng,best[j+1].lat,best[j+1].lng);
      if(d2<d1-0.001){best=[...best.slice(0,i),...best.slice(i,j+1).reverse(),...best.slice(j+1)];imp=true;}
    }
  }
  return best;
}
function dk(a,b,c,d){const R=6371,dL=(c-a)*Math.PI/180,dG=(d-b)*Math.PI/180,x=Math.sin(dL/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dG/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}

function navCur(){const p=getPend()[curIdx];if(p)doNav(p);}
function callCur(){const p=getPend()[curIdx];if(p?.phone)window.open('tel:'+p.phone);}

async function delCur(){
  const pend=getPend();const p=pend[curIdx]||pend[0];if(!p)return;
  const idx=P.findIndex(x=>x.id===p.id);
  if(idx!==-1){P[idx].delivered=true;P[idx].deliveredAt=new Date().toISOString();save();}
  const rem=getPend().length;
  if(rem===0){
    routeOn=false;
    const mins=routeStartTime?Math.round((Date.now()-routeStartTime)/60000):0;
    showT(`üéâ Sab deliver! ~${routeKm.toFixed(1)}km, ${mins} min`,'ok');
    document.getElementById('cur-wrap').style.display='none';
  } else showT(`‚úÖ ${p.name} done! ${rem} baaki`,'ok');
  if(gTok) setTimeout(syncDrive,3000);
  renderHome();
}

function updCurCard(){
  const pend=getPend();const w=document.getElementById('cur-wrap');
  if(!routeOn||pend.length===0){w.style.display='none';return;}
  const p=pend[curIdx]||pend[0];if(!p){w.style.display='none';return;}
  w.style.display='block';
  document.getElementById('cur-nm').textContent=p.name;
  document.getElementById('cur-tel').textContent=p.phone||'';
  document.getElementById('cur-ad').textContent=p.address||'';
  const cph=document.getElementById('cur-ph');
  if(p.photos&&p.photos.length>0)cph.innerHTML=`<img src="${p.photos[0].data}" style="width:100%;height:100%;object-fit:cover;cursor:pointer" onclick="showPhoto('${p.photos[0].data}','${p.name}')">`;
  else cph.innerHTML='<span style="font-size:24px">üì¶</span>';
  const ctn=document.getElementById('cur-tn');
  if(p.timeNote){ctn.style.display='block';ctn.textContent='‚è∞ '+p.timeNote;ctn.style.color=isUrg(p.timeNote)?'var(--red)':'var(--yellow)';}
  else ctn.style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FLOATING PARCEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setFP(id) {
  const p=P.find(x=>x.id===id);if(!p)return;
  selId=id;
  const ph=document.getElementById('fp-ph');
  if(p.photos&&p.photos.length>0) ph.innerHTML=`<img src="${p.photos[0].data}">`;
  else{ph.innerHTML='üì¶';ph.style.fontSize='20px';}
  document.getElementById('fp-nm').textContent=p.name;
  document.getElementById('fp-ph2').textContent=p.phone||'';
  document.getElementById('fp-ad').textContent=p.address||(p.lat?`${p.lat.toFixed(5)},${p.lng.toFixed(5)}`:'No location');
  const ftn=document.getElementById('fp-tn');
  if(p.timeNote){ftn.style.display='block';ftn.textContent='‚è∞ '+p.timeNote;ftn.style.color=isUrg(p.timeNote)?'var(--red)':'var(--yellow)';}
  else ftn.style.display='none';
  document.getElementById('fp').classList.add('show');
  if(p.lat&&p.lng) startProx(p);
}
function clearFP(){selId=null;document.getElementById('fp').classList.remove('show');stopProx();}
function navFP(){const p=P.find(x=>x.id===selId);if(p)doNav(p);}
function callFP(){const p=P.find(x=>x.id===selId);if(p?.phone)window.open('tel:'+p.phone);}
function doNav(p){
  if(p.lat&&p.lng){window.location.href=`google.navigation:q=${p.lat},${p.lng}&mode=d`;setTimeout(()=>window.open(`https://maps.google.com/?daddr=${p.lat},${p.lng}&directionsmode=driving`,'_blank'),1200);}
  else if(p.address)window.open(`https://maps.google.com/?daddr=${encodeURIComponent(p.address)}&directionsmode=driving`,'_blank');
  else showT('Location set nahi!','err');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROXIMITY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startProx(tp){
  stopProx();if(!navigator.geolocation||!tp.lat)return;
  proxWid=navigator.geolocation.watchPosition(pos=>{
    const m=dm(pos.coords.latitude,pos.coords.longitude,tp.lat,tp.lng);
    const el=document.getElementById('prox');
    if(m<=50){el.className='prox vnear';document.getElementById('prox-ic').textContent='üè†';document.getElementById('prox-t').textContent=`Bas ${Math.round(m)}m! Ghar yahi hai!`;document.getElementById('prox-s').textContent=tp.name+' ‚Äî Darwaza dhundho!';if(navigator.vibrate)navigator.vibrate([200,100,300]);}
    else if(m<=150){el.className='prox near';document.getElementById('prox-ic').textContent='üìç';document.getElementById('prox-t').textContent=`${Math.round(m)}m door ‚Äî Paas ho!`;document.getElementById('prox-s').textContent=tp.name+' ‚Äî Ghar dhundho';}
    else el.className='prox';
  },null,{enableHighAccuracy:true,maximumAge:0,timeout:10000});
}
function stopProx(){if(proxWid!==null){navigator.geolocation.clearWatch(proxWid);proxWid=null;}document.getElementById('prox').className='prox';}
function dm(a,b,c,d){const R=6371000,dL=(c-a)*Math.PI/180,dG=(d-b)*Math.PI/180,x=Math.sin(dL/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dG/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TIME NOTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTP(btn,t){document.getElementById('ftn').value=t;document.querySelectorAll('.tp').forEach(b=>b.classList.remove('sel'));btn.classList.add('sel');}
function isUrg(tn){
  if(!tn)return false;const h=new Date().getHours();const n=tn.toLowerCase();
  if(n.includes('9')&&h>=8&&h<=10)return true;if(n.includes('12')&&h>=11&&h<=13)return true;
  if((n.includes('2')||n.includes('3')||n.includes('4'))&&h>=13&&h<=16)return true;
  if(n.includes('5')&&h>=16&&h<=18)return true;if((n.includes('7')||n.includes('8')||n.includes('9'))&&h>=18&&h<=21)return true;
  return false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARCEL CARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pCard(p, num, isCur=false, showActs=true) {
  const urg=p.timeNote&&isUrg(p.timeNote)&&!p.delivered;
  const isToday=todayIds.has(p.id);
  const hasPh=p.photos&&p.photos.length>0;
  let cls=p.delivered?'done':isCur?'active-del':'';
  if(isToday&&!p.delivered)cls+=' today';
  else if(urg)cls+=' urgent';
  else if(p.timeNote&&!p.delivered)cls+=' timed';

  const nbCls=isToday&&!p.delivered?'sel':p.delivered?'done':'';
  const nmCls=urg?'urgent-name':isToday?'today-name':'';

  const thumb=hasPh
    ?`<div class="pthumb" onclick="showPhoto('${p.photos[0].data}','${p.name}');event.stopPropagation()"><img src="${p.photos[0].data}"><div class="pnum ${nbCls}">${num}</div></div>`
    :`<div class="pthumb"><span>${p.delivered?'‚úÖ':p.locationLocked?'üîí':'üì¶'}</span><div class="pnum ${nbCls}">${num}</div></div>`;

  const tnHTML=p.timeNote&&!p.delivered?`<div class="tnotebox ${urg?'urg':''}"><span style="font-size:15px">${urg?'üö®':'‚è∞'}</span><span>${p.timeNote}</span></div>`:'';

  const photosHTML=hasPh&&showActs?`<div class="photo-row">${p.photos.slice(0,4).map(ph=>`<div class="photo-mini" onclick="showPhoto('${ph.data}','${p.name}');event.stopPropagation()"><img src="${ph.data}"></div>`).join('')}${p.photos.length>4?`<div class="photo-mini" style="display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--tx2)">+${p.photos.length-4}</div>`:''}</div>`:'';

  const todayBtn=!p.delivered?`<button class="chip ${isToday?'c-done':'c-nav'}" onclick="toggleToday('${p.id}');event.stopPropagation()">${isToday?'‚úÖ Aaj':'‚òë Aaj'}</button>`:'';

  const acts=showActs?`<div class="chips">
    ${todayBtn}
    ${p.lat?`<button class="chip c-nav" onclick="doNav(P.find(x=>x.id==='${p.id}'));event.stopPropagation()">üó∫Ô∏è Go</button>`:''}
    ${p.phone?`<button class="chip c-call" onclick="window.open('tel:${p.phone}');event.stopPropagation()">üìû</button>`:''}
    <button class="chip c-photo" onclick="addPhotoToP('${p.id}');event.stopPropagation()">üì∏</button>
    <button class="chip c-edit" onclick="openEdit('${p.id}');event.stopPropagation()">‚úè</button>
    ${!p.delivered?`<button class="chip c-done" onclick="quickDone('${p.id}');event.stopPropagation()">‚úì Done</button>`:''}
    <button class="chip c-del" onclick="delP('${p.id}');event.stopPropagation()">üóë</button>
  </div>`:'';

  return `<div class="pcard ${cls}" id="pc-${p.id}" onclick="setFP('${p.id}')">
    <div class="pcard-top">
      ${thumb}
      <div style="flex:1;min-width:0">
        <div class="pname ${nmCls}">${p.name}</div>
        <div class="psub">${p.phone||''}${p.phone&&(p.address||p.barcode)?' ‚Ä¢ ':''}</div>
        <div class="paddr">${p.address||''}</div>
        ${p.barcode?`<div style="font-size:11px;color:var(--blue);margin-top:2px">üì∑ ${p.barcode}</div>`:''}
        ${hasPh?`<div style="font-size:11px;color:var(--teal);margin-top:2px">üì∏ ${p.photos.length} photo (~${p.photos.reduce((s,ph)=>s+Math.round(ph.data.length*0.75/1024),0)}KB)</div>`:''}
        ${isToday&&!p.delivered?`<div style="font-size:11px;color:var(--green);font-weight:700;margin-top:2px">‚úÖ Aaj ke route mein</div>`:''}
      </div>
    </div>
    ${tnHTML}
    ${photosHTML}
    ${acts}
  </div>`;
}

function toggleToday(id) {
  if(todayIds.has(id)) todayIds.delete(id); else todayIds.add(id);
  save(); renderParcels(); renderHome();
  showT(todayIds.has(id)?'‚úÖ Aaj ke route mein add hua!':'Route se remove hua','ok');
  const bar=document.getElementById('today-bar');
  if(todayIds.size>0){bar.style.display='block';document.getElementById('today-title').textContent=todayIds.size+' parcels aaj ke liye';}
  else bar.style.display='none';
}
function quickDone(id){const idx=P.findIndex(x=>x.id===id);if(idx!==-1){P[idx].delivered=true;P[idx].deliveredAt=new Date().toISOString();save();renderParcels();renderHome();if(gTok)setTimeout(syncDrive,3000);showT('‚úÖ Delivered!','ok');}}
function delP(id){if(!confirm('Delete?'))return;P=P.filter(p=>p.id!==id);todayIds.delete(id);save();renderParcels();renderHome();showT('Deleted','err');}
function openEdit(id){fPhotos=[...(P.find(x=>x.id===id)?.photos||[])];openAdd(P.find(x=>x.id===id));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTER & LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setF(btn, f) {
  filt=f; document.querySelectorAll('.ftab').forEach(b=>b.classList.remove('on')); btn.classList.add('on'); renderParcels();
}
function renderParcels() {
  const q=(document.getElementById('srch')?.value||'').toLowerCase();
  let list=[...P];
  if(filt==='pending')list=list.filter(p=>!p.delivered);
  else if(filt==='done')list=list.filter(p=>p.delivered);
  else if(filt==='timed')list=list.filter(p=>p.timeNote&&!p.delivered);
  else if(filt==='photos')list=list.filter(p=>p.photos&&p.photos.length>0);
  else if(filt==='today')list=list.filter(p=>todayIds.has(p.id));
  if(q)list=list.filter(p=>[p.name,p.phone||'',p.address||'',p.barcode||'',p.timeNote||''].join(' ').toLowerCase().includes(q));
  const el=document.getElementById('plist');
  if(list.length===0){el.innerHTML='<div class="empty"><div>üì≠</div><div>Koi parcel nahi mila</div></div>';return;}
  el.innerHTML=list.map((p,i)=>pCard(p,i+1,false,true)).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD/EDIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAdd(ex=null) {
  if(!ex)fPhotos=[];
  document.getElementById('add-mod').classList.add('active');
  document.getElementById('mod-tit').textContent=ex?'Edit Parcel':'Add New Parcel';
  document.getElementById('eid').value=ex?.id||'';
  document.getElementById('fn').value=ex?.name||'';
  document.getElementById('fph').value=ex?.phone||'';
  document.getElementById('fbc').value=ex?.barcode||'';
  document.getElementById('fad').value=ex?.address||'';
  document.getElementById('ftn').value=ex?.timeNote||'';
  document.getElementById('fno').value=ex?.notes||'';
  document.getElementById('ltog').className='tog'+(ex?.locationLocked?' on':'');
  selLat=ex?.lat||null; selLng=ex?.lng||null;
  updLD(); renderFGrid();
  if(selLat&&selLng) setTimeout(initMMap,100);
}
function closeMod(id){document.getElementById(id).classList.remove('active');if(id==='add-mod'){selLat=null;selLng=null;}}

function updLD() {
  const el=document.getElementById('loc-d');
  if(selLat&&selLng){el.textContent=`‚úÖ Bilkul exact: ${selLat.toFixed(6)}, ${selLng.toFixed(6)}`;el.style.color='var(--green)';document.getElementById('mmap-w').style.display='block';}
  else{el.textContent='Set nahi hai ‚Äî Map pe pick karo';el.style.color='var(--tx2)';document.getElementById('mmap-w').style.display='none';}
}
function initMMap(){
  if(!selLat)return;
  if(!mMap){mMap=L.map('mmap',{zoomControl:false,attributionControl:false,dragging:false,scrollWheelZoom:false});L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19}).addTo(mMap);}
  mMap.setView([selLat,selLng],18);
  if(mMark)mMap.removeLayer(mMark);
  mMark=L.marker([selLat,selLng]).addTo(mMap);
  setTimeout(()=>mMap.invalidateSize(),100);
}
function saveParcel(){
  const name=document.getElementById('fn').value.trim();if(!name){showT('Naam required!','err');return;}
  const id=document.getElementById('eid').value;
  const data={name,phone:document.getElementById('fph').value.trim(),barcode:document.getElementById('fbc').value.trim(),address:document.getElementById('fad').value.trim(),timeNote:document.getElementById('ftn').value.trim(),notes:document.getElementById('fno').value.trim(),locationLocked:document.getElementById('ltog').classList.contains('on'),lat:selLat,lng:selLng,photos:[...fPhotos]};
  if(id){const idx=P.findIndex(p=>p.id===id);if(idx!==-1)P[idx]={...P[idx],...data,updatedAt:new Date().toISOString()};}
  else P.push({...data,id:uid(),delivered:false,createdAt:new Date().toISOString()});
  save();closeMod('add-mod');renderParcels();renderHome();
  if(gTok)setTimeout(syncDrive,2000);
  showT(id?'‚úÖ Updated!':'‚úÖ Parcel add ho gaya!','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCATION PICKER ‚Äî SATELLITE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openLP(){
  document.getElementById('lmod').classList.add('active');
  setTimeout(()=>{
    if(!pMap){
      pMap=L.map('lpmap',{zoomControl:true,attributionControl:false});
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19}).addTo(pMap);
      pMap.setView(selLat?[selLat,selLng]:[28.6139,77.2090],selLat?19:12);
      pMap.on('moveend',onPME);pMap.on('move',onPM);
    } else {pMap.invalidateSize();if(selLat)pMap.setView([selLat,selLng],19);}
    onPME();
  },150);
}
function onPM(){const c=pMap.getCenter();document.getElementById('lp-coord').textContent=`${c.lat.toFixed(7)}, ${c.lng.toFixed(7)}`;}
async function onPME(){
  const c=pMap.getCenter();document.getElementById('lp-coord').textContent=`${c.lat.toFixed(7)}, ${c.lng.toFixed(7)}`;
  document.getElementById('lp-addr').textContent='üì° Address dhundh raha hai...';
  try{const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${c.lat}&lon=${c.lng}&format=json&zoom=18`);const d=await r.json();document.getElementById('lp-addr').textContent=d.display_name||`${c.lat.toFixed(6)},${c.lng.toFixed(6)}`;}
  catch{document.getElementById('lp-addr').textContent=`${c.lat.toFixed(6)}, ${c.lng.toFixed(6)}`;}
}
function confirmLoc(){
  const c=pMap.getCenter();selLat=c.lat;selLng=c.lng;
  const addr=document.getElementById('lp-addr').textContent;
  if(addr&&!addr.startsWith('üì°')&&!document.getElementById('fad').value.trim())document.getElementById('fad').value=addr;
  closeLP();updLD();setTimeout(initMMap,100);showT('üìç Location saved!','ok');
}
function closeLP(){document.getElementById('lmod').classList.remove('active');}
function myGPS(){
  const box=document.getElementById('gbox');const t=document.getElementById('gbox-t');const s=document.getElementById('gbox-s');
  box.className='gbox show gwarn';t.textContent='üì° GPS dhundh raha hai...';s.textContent='Thoda wait karein...';
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude,lng=pos.coords.longitude,acc=Math.round(pos.coords.accuracy);
    pMap.setView([lat,lng],20);
    if(acc<=15){box.className='gbox show gok';t.textContent=`‚úÖ Bilkul Exact! ¬±${acc}m`;}
    else if(acc<=50){box.className='gbox show gwarn';t.textContent=`‚ö†Ô∏è GPS ¬±${acc}m ‚Äî Khule mein jao`;}
    else{box.className='gbox show gbad';t.textContent=`‚ùå GPS Weak ¬±${acc}m ‚Äî Bahar jao`;}
    s.textContent='Ghar ke DARWAZE pe pin lagao!';
    showT(`üìç GPS: ¬±${acc}m`,'ok');
  },()=>{box.className='gbox show gbad';t.textContent='‚ùå GPS Permission Denied';s.textContent='Settings mein Location ON karo';},{enableHighAccuracy:true,timeout:15000,maximumAge:0});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCANNER ‚Äî ZXING (all barcode types)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let zxR2=null,zxFR2=null;
async function startScanner(){
  if(scanOn)return;scanOn=true;
  document.getElementById('scan-res').style.display='none';
  try{
    if(!zxR2)zxR2=new ZXing.BrowserMultiFormatReader();
    await zxR2.decodeFromConstraints({video:{facingMode:{ideal:'environment'},width:{ideal:1280}}},document.getElementById('scan-vid'),(result,err)=>{if(result)onScan(result.getText());});
  }catch{showT('Camera permission denied','err');scanOn=false;}
}
function stopScan(){scanOn=false;if(zxR2){try{zxR2.reset();}catch{}}}
async function scanForm(){
  document.getElementById('fscan-mod').classList.add('active');
  try{if(!zxFR2)zxFR2=new ZXing.BrowserMultiFormatReader();
    await zxFR2.decodeFromConstraints({video:{facingMode:{ideal:'environment'}}},document.getElementById('fscan-vid'),(result,err)=>{if(result){document.getElementById('fbc').value=result.getText();closeFormScan();showT('‚úÖ Scan: '+result.getText(),'ok');}});}
  catch{showT('Camera denied','err');}
}
function closeFormScan(){document.getElementById('fscan-mod').classList.remove('active');if(zxFR2){try{zxFR2.reset();}catch{}}}

function onScan(code){
  stopScan();
  document.getElementById('scan-code').textContent=code;
  document.getElementById('scan-res').style.display='block';
  const match=P.find(p=>p.barcode===code);
  if(match){
    // ‚úÖ AUTOMATICALLY aaj ke route mein add karo!
    todayIds.add(match.id);
    save();
    // Today bar update karo
    document.getElementById('today-bar').style.display='block';
    document.getElementById('today-title').textContent=todayIds.size+' parcels aaj ke liye';
    document.getElementById('s3').textContent=[...todayIds].filter(id=>!P.find(p=>p.id===id)?.delivered).length;

    document.getElementById('scan-match').innerHTML=`<div style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:11px;padding:12px">
      <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;background:linear-gradient(135deg,#34D399,#60A5FA);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px">‚úÖ ${match.name}</div>
      <div style="font-size:12px;color:var(--tx2);margin-bottom:6px">${match.phone||''} ${match.address?'‚Ä¢ '+match.address:''}</div>
      ${match.timeNote?`<div style="font-size:12px;color:var(--yellow);margin-bottom:8px">‚è∞ ${match.timeNote}</div>`:''}
      <div style="background:rgba(16,185,129,0.15);border-radius:8px;padding:8px 10px;font-size:13px;font-weight:600;color:#34D399">‚úÖ Aaj ke route mein add ho gaya! (${todayIds.size} total)</div>
      <div style="display:flex;gap:7px;margin-top:10px">
        ${match.lat?`<button class="chip c-nav" onclick="doNav(P.find(x=>x.id==='${match.id}'))">üó∫Ô∏è Navigate</button>`:''}
        ${match.phone?`<button class="chip c-call" onclick="window.open('tel:${match.phone}')">üìû Call</button>`:''}
        <button class="chip c-edit" onclick="openEdit('${match.id}')">‚úè Edit</button>
      </div>
    </div>`;
    showT(`‚úÖ ${match.name} ‚Äî Aaj ke route mein!`,'ok');
    setFP(match.id);
  } else {
    document.getElementById('scan-match').innerHTML=`<div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:11px;padding:12px">
      <div style="font-size:14px;font-weight:600;color:var(--orange);margin-bottom:6px">‚ö†Ô∏è Koi parcel nahi mila</div>
      <div style="font-size:13px;color:var(--tx2)">Naya parcel add karo is barcode ke saath!</div>
    </div>`;
    showT('Barcode match nahi mila ‚Äî Add karo!','err');
  }
  window._lc=code;
}
function addFromScan(){openAdd();document.getElementById('fbc').value=window._lc||'';}
function manSearch(){const c=document.getElementById('man-bc').value.trim();if(c)onScan(c);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OCR ‚Äî Camera se text scan
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setScanMode(mode,btn){
  scanMode=mode;
  document.querySelectorAll('.stab').forEach(b=>b.classList.remove('on'));btn.classList.add('on');
  document.getElementById('mode-bc').style.display=mode==='bc'?'block':'none';
  document.getElementById('mode-ocr').style.display=mode==='ocr'?'block':'none';
  if(mode==='bc')startScanner();else stopScan();
}
async function doOCR(e){
  const file=e.target.files[0];if(!file)return;
  const box=document.getElementById('ocr-box');const msg=document.getElementById('ocr-msg');
  const fill=document.getElementById('ocr-fill');const txt=document.getElementById('ocr-txt');
  box.classList.add('show');msg.textContent='Text padhh raha hai... ‚è≥';fill.style.width='15%';
  try{
    const w=await Tesseract.createWorker('eng+hin',1,{logger:m=>{if(m.status==='recognizing text')fill.style.width=Math.round(m.progress*100)+'%';}});
    const {data:{text}}=await w.recognize(file);await w.terminate();
    fill.style.width='100%';
    const clean=text.trim().replace(/\n+/g,' ');
    txt.textContent='Padha: '+clean.slice(0,80);
    msg.textContent='‚úÖ Text mila!';
    ocrSearch(clean);
  }catch{msg.textContent='‚ùå Text nahi padha. Dobara try karo.';fill.style.width='0%';}
  e.target.value='';
}
function ocrSearch(text){
  const words=text.toLowerCase().split(/\s+/).filter(w=>w.length>2);
  const results=P.filter(p=>{const hay=(p.name+' '+(p.address||'')+' '+(p.phone||'')+' '+(p.barcode||'')).toLowerCase();return words.some(w=>hay.includes(w));});
  showOCRRes(results);
}
function ocrManS(){const q=document.getElementById('ocr-man').value.trim();if(q)ocrSearch(q);}
function showOCRRes(results){
  const el=document.getElementById('ocr-res');
  if(!results.length){el.innerHTML=`<div style="color:var(--tx2);font-size:13px;padding:6px 0">Koi parcel nahi mila. Search modify karo.</div>`;return;}
  el.innerHTML=`<div style="color:var(--green);font-weight:700;margin-bottom:9px">‚úÖ ${results.length} parcel${results.length>1?'s':''} mile!</div>`+
    results.map(p=>`<div style="background:var(--s2);border-radius:11px;padding:11px;margin-bottom:8px;border:1px solid var(--br)">
      <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;background:linear-gradient(135deg,#60A5FA,#A78BFA);-webkit-background-clip:text;-webkit-text-fill-color:transparent">${p.name}</div>
      <div style="font-size:12px;color:var(--tx2);margin-top:3px">${p.phone||''} ${p.address?'‚Ä¢ '+p.address:''}</div>
      ${p.timeNote?`<div style="font-size:11px;color:var(--yellow);margin-top:3px">‚è∞ ${p.timeNote}</div>`:''}
      <div style="display:flex;gap:7px;margin-top:9px">
        <button class="chip c-done" onclick="todayIds.add('${p.id}');save();showT('‚úÖ Route mein add hua!','ok');document.getElementById('today-bar').style.display='block';document.getElementById('today-title').textContent=todayIds.size+' parcels aaj ke liye'">‚òë Aaj Add</button>
        ${p.lat?`<button class="chip c-nav" onclick="doNav(P.find(x=>x.id==='${p.id}'))">üó∫Ô∏è Go</button>`:''}
        ${p.phone?`<button class="chip c-call" onclick="window.open('tel:${p.phone}')">üìû</button>`:''}
      </div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT / IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportJSON(){
  try {
    const json = JSON.stringify({version:8,exportedAt:new Date().toISOString(),parcels:P}, null, 2);
    const blob = new Blob([json], {type:'application/json'});
    const nm = `dp_backup_${ds()}.json`;
    // Mobile friendly download
    if(navigator.share && navigator.canShare) {
      const file = new File([blob], nm, {type:'application/json'});
      if(navigator.canShare({files:[file]})) {
        navigator.share({files:[file], title:'DeliverPro Backup'});
        showT('üì§ Share karo backup file!','ok'); return;
      }
    }
    dl(blob, nm);
    showT('üíæ Backup download ho raha hai!','ok');
  } catch(e){ showT('‚ùå Error: '+e.message,'err'); }
}

function exportCSV(){
  try {
    const h=['Name','Phone','Barcode','Address','TimeNote','Lat','Lng','Photos','Delivered'];
    const rows=P.map(p=>[p.name,p.phone||'',p.barcode||'',(p.address||'').replace(/,/g,'|'),p.timeNote||'',p.lat||'',p.lng||'',(p.photos||[]).length,p.delivered?'Yes':'No']);
    const csv = [h,...rows].map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    if(navigator.share && navigator.canShare) {
      const file = new File([blob], `dp_${ds()}.csv`, {type:'text/csv'});
      if(navigator.canShare({files:[file]})) {
        navigator.share({files:[file], title:'DeliverPro CSV'});
        showT('üì§ CSV share karo!','ok'); return;
      }
    }
    dl(blob, `dp_${ds()}.csv`);
    showT('üìä CSV download ho raha hai!','ok');
  } catch(e){ showT('‚ùå Error: '+e.message,'err'); }
}

function waBackup(){
  try {
    const json = JSON.stringify({version:8,exportedAt:new Date().toISOString(),parcels:P}, null, 2);
    const blob = new Blob([json], {type:'application/json'});
    const nm = `dp_backup_${ds()}.json`;
    if(navigator.share && navigator.canShare) {
      const file = new File([blob], nm, {type:'application/json'});
      if(navigator.canShare({files:[file]})) {
        navigator.share({files:[file], title:'DeliverPro Backup ‚Äî WhatsApp pe bhejo!'});
        showT('üí¨ WhatsApp pe share karo!','ok'); return;
      }
    }
    // Fallback
    dl(blob, nm);
    setTimeout(()=>{
      const msg = encodeURIComponent('DeliverPro Backup üì¶\n'+new Date().toLocaleDateString('hi-IN')+'\n\nFile download hui ‚Äî apne aap ko WhatsApp pe bhejo!');
      window.open('https://wa.me/?text='+msg,'_blank');
    },800);
    showT('File download + WhatsApp open!','ok');
  } catch(e){ showT('‚ùå Error: '+e.message,'err'); }
}

function doImport(e) {
  const f = e.target.files[0]; if(!f) return;
  showT('üìÇ File padh raha hai...', '');
  const r = new FileReader();
  r.onload = ev => {
    try {
      let d;
      try { d = JSON.parse(ev.target.result); }
      catch { showT('‚ùå File corrupt hai', 'err'); return; }
      let imp = [];
      if(Array.isArray(d)) imp = d;
      else if(d.parcels && Array.isArray(d.parcels)) imp = d.parcels;
      else if(d.data && Array.isArray(d.data)) imp = d.data;
      if(imp.length === 0) { showT('‚ùå Koi parcel nahi mila', 'err'); return; }
      const ex = new Set(P.map(p => p.id));
      let n = 0;
      imp.forEach(p => {
        if(!p.id) p.id = uid();
        if(!p.photos) p.photos = [];
        if(!ex.has(p.id)) { P.push(p); n++; ex.add(p.id); }
      });
      save(); renderHome(); renderParcels();
      showT(`‚úÖ ${n} parcels restore hue! Total: ${P.length}`, 'ok');
    } catch(err) { showT('‚ùå Error: ' + err.message, 'err'); }
    e.target.value = '';
  };
  r.onerror = () => showT('‚ùå File read nahi hui', 'err');
  r.readAsText(f, 'UTF-8');
}

function clearAll(){if(!confirm('Sab data delete?'))return;if(!confirm('SURE?'))return;P=[];todayIds.clear();save();routeOn=false;clearFP();renderHome();renderParcels();showT('Cleared','err');}
function dl(blob,nm){
  try {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = nm;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 1000);
  } catch(e){ showT('‚ùå Download error: '+e.message,'err'); }
}
function ds(){return new Date().toISOString().slice(0,10);}
function shareApp(){if(navigator.share)navigator.share({title:'DeliverPro',url:window.location.href});else{navigator.clipboard?.writeText(window.location.href);showT('Link copied!','ok');}}
function updIO(){
  document.getElementById('app-url').textContent=window.location.href;
  const sz=new Blob([localStorage.getItem('dp8')||'']).size;
  const totPh=P.reduce((s,p)=>s+(p.photos||[]).length,0);
  const totKB=P.reduce((s,p)=>s+(p.photos||[]).reduce((ss,ph)=>ss+Math.round(ph.data.length*0.75/1024),0),0);
  const pct = Math.round(sz/50000); // ~5MB limit
  const warn = sz > 4000000 ? '‚ö†Ô∏è Storage almost full!' : sz > 2000000 ? 'üü° Half full' : 'üü¢ OK';
  document.getElementById('stinfo').innerHTML=`
    <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--tx2)">Total Parcels</span><span style="font-weight:700">${P.length}</span></div>
    <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--tx2)">Storage Used</span><span style="font-weight:700">${(sz/1024).toFixed(0)}KB / 5120KB ${warn}</span></div>
    <div style="background:var(--s2);border-radius:6px;height:8px;margin-bottom:10px;overflow:hidden"><div style="height:100%;width:${Math.min(pct,100)}%;background:${sz>4000000?'var(--red)':sz>2000000?'var(--orange)':'var(--green)'};border-radius:6px"></div></div>
    <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--tx2)">Photos</span><span style="font-weight:700;color:var(--teal)">${totPh} photos (~${totKB}KB)</span></div>
    <div style="display:flex;justify-content:space-between"><span style="color:var(--tx2)">Drive Sync</span><span style="font-weight:700;color:${gTok?'var(--green)':'var(--tx3)'}">${gTok?'‚úÖ Connected':'‚ùå Login karo'}</span></div>
    ${sz > 3000000 ? `<div style="margin-top:10px;padding:10px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:9px;font-size:12px;color:var(--orange)">‚ö†Ô∏è Storage zyada bhar raha hai! Google Drive sync karo ‚Äî photos wahan safe rahenge!</div>` : ''}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goScr(nm,btn){
  document.querySelectorAll('.scr').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('active'));
  document.getElementById('scr-'+nm).classList.add('active');btn.classList.add('active');
  if(nm==='home')renderHome();
  if(nm==='parcels')renderParcels();
  if(nm!=='scan')stopScan();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showT(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show'+(type?' '+type:'');setTimeout(()=>t.className='toast',3000);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
load(); updStats();
setTimeout(async ()=>{
  renderHome();
  if(gUser) updGBar(true);
  await checkAuth();
  // Agar local data nahi hai lekin Drive connected hai ‚Äî auto load!
  if(P.length === 0 && gTok) {
    showT('‚òÅÔ∏è Drive se data load ho raha hai...', '');
    setTimeout(loadDrive, 1000);
  }
  // Show today bar if any selected
  if(todayIds.size>0){
    document.getElementById('today-bar').style.display='block';
    document.getElementById('today-title').textContent=todayIds.size+' parcels aaj ke liye';
  }
},200);
document.getElementById('add-mod').addEventListener('click',function(e){if(e.target===this)closeMod('add-mod');});
document.getElementById('fscan-mod').addEventListener('click',function(e){if(e.target===this)closeFormScan();});
document.getElementById('sel-mod').addEventListener('click',function(e){if(e.target===this)closeMod('sel-mod');});
document.querySelectorAll('.nb').forEach((b,i)=>b.addEventListener('click',()=>{if(i!==2)stopScan();}));
</script>
</body>
</html>
